---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: gateways

resources:
- ./protected-gateway.yaml
- ../../../ingress/manual-certificates/domain-info/

configMapGenerator:
- name: main-protected-gateway-class-info
  envs:
  - ./env/gateway-class.env
  options:
    annotations:
      config.kubernetes.io/local-config: 'true'

replacements:
- source:
    kind: ConfigMap
    name: main-protected-gateway-class-info
    fieldPath: data.gateway_class
  targets:
  - select:
      kind: Gateway
      name: main-protected
    fieldPaths:
    - spec.gatewayClassName
- source:
    kind: ConfigMap
    name: domain-info-public-protected
    fieldPath: data.secret_name
  targets:
  - select:
      kind: Gateway
      name: main-protected
    fieldPaths:
    - spec.listeners.1.tls.certificateRefs.0.name
- source:
    kind: ConfigMap
    name: domain-info-public-protected
    fieldPath: data.domain_suffix
  targets:
  - select:
      kind: Gateway
      name: main-protected
    options:
      delimiter: .
      index: 1
    fieldPaths:
    - spec.listeners.1.hostname
