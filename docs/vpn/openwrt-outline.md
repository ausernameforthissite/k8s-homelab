
# Outline client on OpenWRT

In this guide, we set up the `shadowsocks-libev` Outline/Shadowsocks client.
As a result, all traffic of devices connected to that OpenWRT instance will be routed through Outline.

# Sources

- [shadowsocks-libev setup guide (in Russian)](https://habr.com/ru/articles/748408/)

# Prerequisites

- [OpenWRT](./openwrt.md)

# Installation

```bash
opkg update
opkg install shadowsocks-libev-ss-local shadowsocks-libev-ss-redir
opkg install shadowsocks-libev-ss-rules shadowsocks-libev-ss-tunnel
opkg install luci-app-shadowsocks-libev
opkg install coreutils-base64
opkg install bind-dig

 cat << "SCRIPT_EOF" > ./setup-outline.sh
#!/bin/bash
set -e

ADDRESS=$1
ADDRESS_REGEX='ss://([A-Za-z0-9]+)@([.0-9]+):([0-9]+)/\?outline=1'
[[ $ADDRESS =~ $ADDRESS_REGEX ]]
BASE64_PASSWORD=${BASH_REMATCH[1]}
OUTLINE_IP=${BASH_REMATCH[2]}

OUTLINE_PORT=${BASH_REMATCH[3]}
LEFT_PORT=$(($OUTLINE_PORT-1))
RIGHT_PORT=$(($OUTLINE_PORT+1))

METHOD_PASSWORD=$(echo $BASE64_PASSWORD | base64 -d)
PASSWORD_REGEX='([a-z0-9-]+):([A-Za-z0-9]+)'
[[ $METHOD_PASSWORD =~ $PASSWORD_REGEX ]]
OUTLINE_METHOD=${BASH_REMATCH[1]}
OUTLINE_PASSWORD=${BASH_REMATCH[2]}

cat << EOF > /etc/config/shadowsocks-libev
config server 'sss0'
        option server '$OUTLINE_IP'
        option server_port '$OUTLINE_PORT'
        option password '$OUTLINE_PASSWORD'
        option method '$OUTLINE_METHOD'

config ss_redir 'hj'
        option server 'sss0'
        option local_address '0.0.0.0'
        option local_port '1100'
        option mode 'tcp_and_udp'
        option timeout '60'
        option fast_open '1'
        option reuse_port '1'

config ss_rules 'ss_rules'
        option src_default 'checkdst'
        option dst_forward_recentrst '0'
        option redir_tcp 'hj'
        option redir_udp 'hj'
        option local_default 'forward'
        option dst_default 'forward'
        option nft_tcp_extra 'tcp dport { 80-$LEFT_PORT, $RIGHT_PORT-65535 }'
        option nft_udp_extra 'udp dport { 53-65535 }'
EOF
SCRIPT_EOF
chmod +x ./setup-outline.sh

bypass_update_script=/root/shadowsocks-bypass-update.sh
 cat << "EOF" > $bypass_update_script
#!/bin/bash
set -e
shopt -s nullglob

bypassList='/etc/shadowsocks-libev/bypass-*.lst'
bypassFile=/etc/shadowsocks-libev/combined-bypass.lst

files=( $bypassList )
if (( ${#files[@]} )); then
    cat $bypassList > $bypassFile
    echo bypass list: $bypassList
else
    echo > $bypassFile
    echo no bypass files found
fi
echo updated $bypassFile
EOF
chmod +x $forward_update_script

forward_update_script=/root/shadowsocks-forward-update.sh
 cat << "EOF" > $forward_update_script
#!/bin/bash
set -e
shopt -s nullglob

forwardList='/etc/shadowsocks-libev/forward-*.lst'
forwardFile=/etc/shadowsocks-libev/combined-forward.lst

files=( $forwardList )
if (( ${#files[@]} )); then
    cat $forwardList > $forwardFile
    echo forward list: $forwardList
else
    echo > $forwardFile
    echo no forward files found
fi
echo updated $forwardFile
EOF
chmod +x $forward_update_script
```

```shell
# set to connection string generated by Outline
address=""
# example: address="ss://qweasdzxc@0.0.0.0:1234/?outline=1"
./setup-outline.sh "$address"

uci set shadowsocks-libev.ss_rules.dst_ips_bypass_file='/etc/shadowsocks-libev/combined-bypass.lst'
uci set shadowsocks-libev.ss_rules.dst_ips_forward_file='/etc/shadowsocks-libev/combined-forward.lst'
# forward all traffic expect from bypass list:
uci set shadowsocks-libev.ss_rules.dst_default='forward'
# alternatively, forward only traffic from forward list:
# uci set shadowsocks-libev.ss_rules.dst_default='bypass'

uci commit shadowsocks-libev
/etc/init.d/shadowsocks-libev restart

# test connection
wget -qO- http://ipecho.net/plain | xargs echo
# you should see the IP of the Outline server
```

# Bypass russian IPs

```bash
opkg update
opkg install jq perl wget curl
# install all the perl modules, because I'm too lazy to look for imports in ipcalc
opkg install $(opkg find '*perlbase*' | grep -E -o '^perlbase[a-z-]+' | tr '\n' ' ')
wget https://raw.githubusercontent.com/kjokjo/ipcalc/refs/heads/master/ipcalc
```

```bash
load_ru_cudr=/root/load-ru-ip.sh
 cat << "EOF" > $load_ru_cudr
#!/bin/bash
set -e

ru_cidr_url="https://stat.ripe.net/data/country-resource-list/data.json?resource=RU"
rawList=$(mktemp)
curl "$ru_cidr_url" | jq -r '.data.resources.ipv4[]' > $rawList

cidr_file=/etc/shadowsocks-libev/bypass-ru_cidr.lst
echo > $cidr_file
grep "/" $rawList >> $cidr_file
grep "/" $rawList -v | xargs -n 1 perl ipcalc | grep -v 'deaggregate' >> $cidr_file
rm $rawList

echo RU CIDR downloaded successfully to $cidr_file

/root/shadowsocks-bypass-update.sh
EOF

chmod +x $load_ru_cudr
$load_ru_cudr

# repeat download every day at 03:07
echo "7 3 */1 * * $load_ru_cudr" >> /etc/crontabs/root
```

# Common bypass lists

```bash
# reddit blocks VPNs
cat << EOF > /etc/shadowsocks-libev/bypass-reddit.lst
151.101.193.140
151.101.1.140
151.101.129.140
151.101.65.140
EOF
# ubisoft: https://ipinfo.io/AS22634
cat << EOF > /etc/shadowsocks-libev/bypass-ubisoft1.lst
130.254.64.0/19
130.254.80.0/23
130.254.82.0/23
130.254.84.0/23
130.254.86.0/23
130.254.88.0/23
130.254.90.0/23
203.132.16.0/20
203.132.17.0/24
203.132.18.0/24
203.132.19.0/24
203.132.20.0/24
203.132.21.0/24
203.132.22.0/24
203.132.23.0/24
203.132.26.0/24
203.132.27.0/24
203.132.29.0/24
212.104.192.0/20
212.104.199.0/24
216.98.48.0/20
EOF
# ubisoft: https://www.netify.ai/resources/applications/ubisoft
cat << EOF > /etc/shadowsocks-libev/bypass-ubisoft2.lst
185.38.20.0/22
194.2.155.0/24
194.169.249.0/24
195.22.144.0/23
EOF

dig +short connect.ubisoft.com ubi.com ubisoft.com www.ubisoft.com | grep '^[.0-9]*$' > /etc/shadowsocks-libev/bypass-ubisoft3.lst
# dig +short www.pixiv.net pixiv.net i.pximg.net | grep '^[.0-9]*$' > /etc/shadowsocks-libev/bypass-pixiv.lst
dig +short pixiv.net i.pximg.net | grep '^[.0-9]*$' > /etc/shadowsocks-libev/bypass-pixiv.lst

/root/shadowsocks-bypass-update.sh
```

# Forward resources blocked by Roskomnadzor

```bash
load_rkn_list=/root/load-rkn-list.sh

 cat << "EOF" > $load_rkn_list
#!/bin/bash
set -e

listFile=/etc/shadowsocks-libev/forward-allyouneed.lst
rm -f $listFile
wget https://antifilter.download/list/allyouneed.lst -O $listFile
echo downloaded $listFile

/root/shadowsocks-forward-update.sh
EOF

chmod +x $load_rkn_list
$load_rkn_list

# repeat download every day at 03:17
echo "17 3 */1 * * $load_rkn_list" >> /etc/crontabs/root
```

# Common forward lists

```bash
# https://github.com/GhostRooter0953/discord-voice-ips
wget https://github.com/GhostRooter0953/discord-voice-ips/raw/refs/heads/master/main_domains/discord-main-ip-list -O /etc/shadowsocks-libev/forward-discord-main.lst
wget https://github.com/GhostRooter0953/discord-voice-ips/raw/refs/heads/master/voice_domains/discord-voice-ip-list -O /etc/shadowsocks-libev/forward-discord-voice.lst

/root/shadowsocks-forward-update.sh
```
