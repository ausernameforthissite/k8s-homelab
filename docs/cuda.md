
Source:
https://docs.nvidia.com/cuda/cuda-installation-guide-linux/

# Install

First disable secure boot.

```bash
# make sure everything is updated

# install packages for kernel
sudo apt-get install linux-headers-$(uname -r)

sudo apt install gcc -y
sudo apt install make -y
```

```bash
sudo nano /etc/modprobe.d/blacklist-nouveau.conf
```
```conf
blacklist nouveau
options nouveau modeset=0
```

```bash
sudo update-initramfs -u
```

```bash
# run installer
wget https://developer.download.nvidia.com/compute/cuda/12.1.1/local_installers/cuda_12.1.1_530.30.02_linux.run &&
chmod +x ./cuda_12.1.1_530.30.02_linux.run &&
sudo sh cuda_12.1.1_530.30.02_linux.run
```

```log
===========
= Summary =
===========

Driver:   Installed
Toolkit:  Installed in /usr/local/cuda-12.1/

Please make sure that
 -   PATH includes /usr/local/cuda-12.1/bin
 -   LD_LIBRARY_PATH includes /usr/local/cuda-12.1/lib64, or, add /usr/local/cuda-12.1/lib64 to /etc/ld.so.conf and run ldconfig as root

To uninstall the CUDA Toolkit, run cuda-uninstaller in /usr/local/cuda-12.1/bin
To uninstall the NVIDIA Driver, run nvidia-uninstall
Logfile is /var/log/cuda-installer.log
```

# Control

```bash
# show all
nvidia-smi -q

# keeps nvidia driver loaded
# this provides better monitoring and faster startup for applications
# doesn't survive reboot
sudo nvidia-smi --id 0 --persistence-mode ENABLED

# tesla p40 doesn't support target temp
# but it seems to throttle around 90°C
# even though it says that slowdown temperature is 96°C
# sudo nvidia-smi --id 0 --gpu-target-temp 75

# My cooling solution is very limited
# Min and max power limit values can be found in nvidia-smi -q | grep 'Power Limit'
sudo nvidia-smi --id 0 --power-limit 125
```

# fan control

```bash
apt-get install -y lm-sensors fancontrol
# https://www.binarytides.com/monitor-cpu-power-consumption-on-ubuntu/
apt install linux-cpupower

sensors-detect
service kmod restart

pwmconfig

systemctl restart fancontrol.service

sensors

# turbostat doesn't seem to work properly with modern systems
turbostat --Summary --quiet --show Busy%,Avg_MHz,PkgTmp,PkgWatt --interval 1
# s-tui supposedly works better, but I'm yet to check this
```

```bash
nano /etc/fancontrol
```
```conf
# Configuration file generated by pwmconfig, changes will be lost
INTERVAL=10
DEVPATH=hwmon1=devices/pci0000:00/0000:00:01.3/0000:02:00.2/0000:03:04.0/0000:0c:00.0/nvme/nvme2 hwmon3=devices/platform/nct6775.656
DEVNAME=hwmon1=nvme hwmon3=nct6779
FCTEMPS=hwmon3/pwm5=hwmon1/temp1_input
FCFANS= hwmon3/pwm5=hwmon3/fan5_input
MINTEMP= hwmon3/pwm5=20
MAXTEMP= hwmon3/pwm5=60
MINSTART= hwmon3/pwm5=199
MINSTOP= hwmon3/pwm5=198
MINPWM= hwmon3/pwm5=197
MAXPWM=hwmon3/pwm5=199
```

# Monitor

```bash
watch -d -n 1 sh -c "nvidia-smi && echo && nvidia-smi --query-gpu=index,pstate,power.draw,clocks.sm,clocks.mem --format=csv"
```
