---
- name: install and configure docker
  hosts: docker
  become: true
  pre_tasks:
  - name: validate configuration (locally)
    run_once: true
    delegate_to: localhost
    ansible.builtin.command: dockerd --validate --config-file ./env/daemon.json
    changed_when: false
  - name: check if docker compose is present
    ansible.builtin.command: docker compose version
    register: docker_ver_check
    changed_when: false
    failed_when: false
  - name: Set docker_installed fact
    ansible.builtin.set_fact:
      docker_installed: "{{ docker_ver_check.rc == 0 }}"

  tasks:
  - name: install docker if missing
    import_role:
      name: geerlingguy.docker
    when: not docker_installed

  - name: copy docker config
    ansible.builtin.copy:
      src: ./env/daemon.json
      dest: /etc/docker/daemon.json
      owner: root
      mode: "0644"
    notify:
    - restart_docker_service

  - name: Add {{ ansible_facts['env']['SUDO_USER'] }} to docker group
    ansible.builtin.user:
      name: "{{ ansible_facts['env']['SUDO_USER'] }}"
      groups: docker
      append: yes

  handlers:
  - name: restart docker.service
    listen:
    - restart_docker_service
    ansible.builtin.systemd_service:
      name: docker.service
      enabled: true
      state: restarted
      daemon_reload: false
