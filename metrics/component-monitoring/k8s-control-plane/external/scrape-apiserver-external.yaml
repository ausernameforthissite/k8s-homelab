---
apiVersion: monitoring.coreos.com/v1alpha1
kind: ScrapeConfig
metadata:
  name: external-kube-apiserver
  namespace: prometheus
  labels:
    prometheus.io/instance: main
    instance.prometheus.io/main: enable
    instance.prometheus.io/prompp: enable
spec:
  scheme: HTTPS
  tlsConfig:
    # caFile: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    ca:
      configMap:
        name: kube-root-ca.crt
        key: ca.crt
    # unlike static pods, external components
    # are under full control of cluster administrator,
    # so they should have proper certificates;
    # and besides, they may be in an insecure network, so cert verification is a must
    insecureSkipVerify: false
  authorization:
    type: Bearer
    credentials:
      name: prometheus-sa-token
      key: token
  relabelings:
  - targetLabel: instance
    sourceLabels: [ __address__ ]
    regex: (.*):\d*
    action: replace
  - targetLabel: job
    action: replace
    replacement: kube-apiserver
  metricRelabelings:
  - action: keep
    sourceLabels: [ __name__ ]
    regex: "\
      apiserver_client_certificate_expiration_.*|\
      apiserver_request_terminations_total|\
      apiserver_request_total|\
      apiserver_response_sizes_.*|\
      apiserver_storage_objects|\
      apiserver_storage_size_bytes|\
      apiserver_tls_handshake_errors_total|\
      kubernetes_build_info|\
      kubernetes_feature_enabled|\
      rest_client_requests_total|\
      apiserver_flowcontrol_demand_seats_average|\
      apiserver_flowcontrol_demand_seats_high_watermark|\
      apiserver_flowcontrol_lower_limit_seats|\
      apiserver_flowcontrol_nominal_limit_seats|\
      apiserver_flowcontrol_target_seats|\
      apiserver_flowcontrol_upper_limit_seats|\
      apiserver_flowcontrol_dispatched_requests_total|\
      apiserver_flowcontrol_rejected_requests_total|\
      apiserver_flowcontrol_current_inqueue_requests|\
      apiserver_flowcontrol_current_executing_requests|\
      apiserver_flowcontrol_current_executing_seats|\
      apiserver_flowcontrol_request_execution_seconds_.*|\
      apiserver_flowcontrol_request_wait_duration_seconds_.*|\
      "
