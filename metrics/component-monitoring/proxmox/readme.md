
# prometheus-pve-exporter

References:
- https://github.com/prometheus-pve/prometheus-pve-exporter/tree/main

Data in proxmox updates every 20 seconds.

# Local environment

```bash

mkdir -p mkdir -p ./metrics/component-monitoring/proxmox/env/
# create this file, create PVE APT token and fill the values
 cat << EOF > ./metrics/component-monitoring/proxmox/env/pve.yml
default:
  # copy from "User name" field
  user: user-name@login-realm
  # You set this to a value you like when creating a token
  # ! do NOT set to full token qualifier, like username@pve!tokenID !
  token_name: token-id
  # Generated by proxmox
  token_value: secret-value
EOF
# note: you should enable role PVEAuditor for the token
# for this you can either add this permission on the token itself
# or set this permission on the user and disable privilege separation on the token

# adjust list of nodes and cluster name
 cat << EOF > ./metrics/component-monitoring/proxmox/env/scrape-node-patch.yaml
---
apiVersion: monitoring.coreos.com/v1alpha1
kind: ScrapeConfig
metadata:
  name: proxmox-node
spec:
  staticConfigs:
  - labels:
      job: proxmox
      cluster: proxmox-cluster-name
    targets:
    - pve1.k8s.lan
    - pve2.k8s.lan
    - pve3.k8s.lan
EOF
# for the cluster scrape set only 1 address
 cat << EOF > ./metrics/component-monitoring/proxmox/env/scrape-cluster-patch.yaml
---
apiVersion: monitoring.coreos.com/v1alpha1
kind: ScrapeConfig
metadata:
  name: proxmox-cluster
spec:
  staticConfigs:
  - labels:
      job: proxmox
      cluster: proxmox-cluster-name
    targets:
    - pve1.k8s.lan
EOF

```

# Updating dashboards

```bash

 # force all panels to use the default data source min interval
 sed -i '/\"interval\":/d' ./metrics/component-monitoring/proxmox/dashboards/*.json
 sed -i 's/\"version\"\: [0-9]*/\"version\": 0/' ./metrics/component-monitoring/proxmox/dashboards/*.json
 sed -i '/\"pluginVersion\":/d' ./metrics/component-monitoring/proxmox/dashboards/*.json
 # avoid id collisions
 sed -i 's/^  \"id\": .*,/  \"id\": null,/' ./metrics/component-monitoring/proxmox/dashboards/*.json
 sed -i 's/^  \"refresh\": \".*s\",/  \"refresh\": \"auto\",/' ./metrics/component-monitoring/proxmox/dashboards/*.json
 # remove local variable values
 sed -i '/        \"current\": {/,/        }\,/d' ./metrics/component-monitoring/proxmox/dashboards/*.json
 sed -i 's/^  \"timezone\": \".*\",/  \"timezone\": \"browser\",/' ./metrics/component-monitoring/proxmox/dashboards/*.json
 # grafana likes to flip some values between {"color":"green","value": null} and {"color":"green"}
 # this forces them all to lose "value": null, so that there are less changes in commits
 sed -i -z -r 's/,\n *\"value\": null(\n *})/\1/g' ./metrics/component-monitoring/proxmox/dashboards/*.json

```

# Deploy

```bash

kl create ns pve-exporter
kl label ns pve-exporter pod-security.kubernetes.io/enforce=baseline

kl -n pve-exporter apply -k ./metrics/component-monitoring/proxmox/
kl -n grafana apply -k ./metrics/component-monitoring/proxmox/dashboards/
kl -n pve-exporter get pod -o wide
kl -n pve-exporter get scrapeconfig

```

TODO: remove node scraping?
Almost all info is in the cluster scrape. Metrics from node scrape seem borderline useless.

# Cleanup

```bash
kl delete -k ./metrics/component-monitoring/proxmox/dashboards/
kl delete -k ./metrics/component-monitoring/proxmox/
kl delete ns pve-exporter
```

# Manual metric checking

```bash

kl -n pve-exporter describe svc pve-exporter

# pick some node randomly
kl exec deployments/alpine -- apk add curl
target=ryzen.proxmox.wrq.duckdns.org
# example: target=pve1.k8s.lan
kl exec deployments/alpine -- curl -sS "http://pve-exporter.pve-exporter:9221/pve?target=$target&cluster=1&node=0" > ./pve-cluster.log
kl exec deployments/alpine -- curl -sS "http://pve-exporter.pve-exporter:9221/pve?target=$target&cluster=0&node=1" > ./pve-node.log

```
