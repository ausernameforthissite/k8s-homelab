# kubelet service is created and maintained by prometheus-operator
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: kubelet
  namespace: kube-system
  labels:
    prometheus.io/instance: main
spec:
  attachMetadata:
    node: false
  jobLabel: k8s-app
  # namespaceSelector:
  #   matchNames:
  #   - kube-system
  selector:
    matchLabels:
      app.kubernetes.io/name: kubelet
      k8s-app: kubelet
  endpoints:
  - port: https-metrics
    scheme: https    
    tlsConfig:
      caFile: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      insecureSkipVerify: true
    bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
    honorLabels: true
    honorTimestamps: true
    metricRelabelings:
    - action: keep
      regex: "\
        kubelet_node_name|\
        kubernetes_build_info|\
        kubelet_active_pods|\
        kubelet_desired_pods|\
        kubelet_running_pods|\
        kubelet_working_pods|\
        kubelet_container_log_filesystem_used_bytes|\
        kubelet_pod_worker_.*|\
        kubelet_volume_stats.*|\
        "
      sourceLabels:
      - __name__
    relabelings:
    - action: replace
      sourceLabels:
      - __metrics_path__
      targetLabel: metrics_path
  - port: https-metrics
    scheme: https
    path: /metrics/cadvisor
    interval: 10s
    honorLabels: true
    honorTimestamps: true
    trackTimestampsStaleness: true    
    tlsConfig:
      caFile: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      insecureSkipVerify: true
    bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
    metricRelabelings:
    # drop metrics for dummy cgroup containers without name
    - sourceLabels:
      - __name__
      - container
      action: drop
      # select only metrics that are linked to containers
      # for example, network metrics do not have container label by design
      regex: 'container_(cpu_|fs_|blkio_|memory_|oom_|start_time_|threads|processes|sockets|ulimits_soft).*;'
      separator: ;
    - sourceLabels:
      - __name__
      - interface
      action: drop
      # drop lxc* interface metrics
      # they are kinda impossible to correlate with k8s objects
      # they don't seem to have any real traffic reported
      # but they give huge cardinality for pods with hostNetwork enabled
      regex: 'container_network_.*;lxc.*'
      separator: ;
    # iops metrics don't seems to be useful ?
    # - sourceLabels: [__name__]
    #   action: drop
    #   regex: 'container_fs_reads_total|container_fs_writes_total'
    # Drop less useful container CPU metrics.
    - sourceLabels: [__name__]
      action: drop
      regex: 'container_cpu_(cfs_throttled_seconds_total|load_average_10s|system_seconds_total|user_seconds_total)'
    # Drop less useful container / always zero filesystem metrics.
    - sourceLabels: [__name__]
      action: drop
      regex: 'container_fs_(io_current|io_time_seconds_total|io_time_weighted_seconds_total|reads_merged_total|sector_reads_total|sector_writes_total|writes_merged_total)'
    # Drop less useful / always zero container memory metrics.
    - sourceLabels: [__name__]
      action: drop
      # regex: 'container_memory_swap|container_memory_kernel_usage|container_memory_mapped_file'
      regex: 'container_memory_swap|container_memory_kernel_usage'
    # Drop less useful container process metrics.
    - sourceLabels: [__name__]
      action: drop
      regex: 'container_(file_descriptors|tasks_state|threads_max)'
    # Drop container spec metrics that overlap with kube-state-metrics.
    - sourceLabels: [__name__]
      action: drop
      regex: 'container_spec.*'
    # Drop cgroup metrics with no pod.
    - sourceLabels: [id, pod]
      action: drop
      regex: '.+;'
    - action: drop
      regex: container_last_seen
      sourceLabels:
      - __name__
    relabelings:
    - action: replace
      sourceLabels:
      - __metrics_path__
      targetLabel: metrics_path
  - port: https-metrics
    scheme: https
    path: /metrics/probes
    honorLabels: true
    honorTimestamps: true    
    tlsConfig:
      caFile: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      insecureSkipVerify: true
    bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
    relabelings:
    - action: replace
      sourceLabels:
      - __metrics_path__
      targetLabel: metrics_path
