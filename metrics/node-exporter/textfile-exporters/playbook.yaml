---
- name: install node_textfile as systemd service
  hosts: node_textfile
  become: true
  tasks:
  - name: install dependencies
    ansible.builtin.apt:
      name:
      # apt_info.py dependencies
      - python3-apt
      - python3-prometheus-client
      # sponge
      - moreutils

  - name: create /opt/
    ansible.builtin.file:
      path: /opt/
      state: directory
      mode: "0755"
      owner: root
      group: root

  - name: copy apt_info.py
    ansible.builtin.copy:
      src: ./apt_info.py
      dest: /opt/apt_info.py
      owner: root
      group: root
      mode: "0755"

  - name: copy apt-conf-auto-update.conf
    ansible.builtin.copy:
      src: ./apt-conf-auto-update.conf
      dest: /etc/apt/apt.conf.d/99_auto_apt_update.conf
      owner: root
      group: root
      mode: "0755"

  - name: copy node-textfile-apt_info.service
    ansible.builtin.copy:
      src: ./node-textfile-apt_info.service
      dest: /etc/systemd/system/node-textfile-apt_info.service
      owner: root
      group: root
      mode: "0644"
    notify:
    - systemd_daemon_reload

  - name: copy node-textfile-apt_info.timer
    ansible.builtin.copy:
      src: ./node-textfile-apt_info.timer
      dest: /etc/systemd/system/node-textfile-apt_info.timer
      owner: root
      group: root
      mode: "0644"
    notify:
    - systemd_daemon_reload
    - systemd_restart_textfile_timer

  handlers:
  - name: systemd-daemon-reload
    listen:
    - systemd_daemon_reload
    systemd:
      daemon_reload: true

  - name: start node-textfile-apt_info.timer
    listen:
    - systemd_restart_textfile_timer
    systemd:
      name: node-textfile-apt_info.timer
      enabled: true
      state: restarted
      daemon_reload: false
