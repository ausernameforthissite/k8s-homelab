---
- name: Install and enable monitoring systemd timer
  hosts: node_textfile
  become: true
  tasks:
  - name: Install dependencies
    ansible.builtin.apt:
      name:
      # apt_info.py dependencies
      - python3-apt
      - python3-prometheus-client
      # sponge
      - moreutils
  - name: Ensure /opt exists
    file:
      path: /opt/
      state: directory
      mode: "0755"
      owner: root
      group: root
  - name: Copy monitoring script
    copy:
      src: ./apt_info.py
      dest: /opt/apt_info.py
      owner: root
      group: root
      mode: "0755"
  - name: Copy apt config
    copy:
      src: ./apt-conf-auto-update.conf
      dest: /etc/apt/apt.conf.d/99_auto_apt_update.conf
      owner: root
      group: root
      mode: "0755"
  - name: Deploy service unit
    template:
      src: ./node-textfile-apt_info.service
      dest: /etc/systemd/system/node-textfile-apt_info.service
      owner: root
      group: root
      mode: "0644"
    notify: systemd-daemon-reload
  - name: Deploy timer unit
    template:
      src: ./node-textfile-apt_info.timer
      dest: /etc/systemd/system/node-textfile-apt_info.timer
      owner: root
      group: root
      mode: "0644"
    notify: systemd-daemon-reload
  - name: Start timer
    systemd:
      name: node-textfile-apt_info.timer
      enabled: yes
      state: started
      daemon_reload: no
  handlers:
  - name: systemd-daemon-reload
    systemd:
      daemon_reload: yes
    listen: systemd-daemon-reload
