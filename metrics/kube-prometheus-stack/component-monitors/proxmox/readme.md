
# prometheus-pve-exporter

References:
- https://github.com/prometheus-pve/prometheus-pve-exporter/tree/main

Data in proxmox updates every 20 seconds.

# Local environment

```bash
mkdir -p mkdir -p ./metrics/kube-prometheus-stack/component-monitors/proxmox/env/
# create this file, create PVE APT token and fill the values
cat << EOF > ./metrics/kube-prometheus-stack/component-monitors/proxmox/env/pve.yml
default:
  # copy from "User name" field
  user: user-name@login-realm
  # You set this to a value you like when creating a token
  # ! do NOT set to full token qualifier, like username@pve!tokenID !
  token_name: token-id
  # Generated by proxmox
  token_value: secret-value
EOF
# note: you should enable role PVEAuditor for the token
# for this you can either add this permission on the token itself
# or set this permission on the user and disable privilege separation on the token

# init scrape config using your local environment info
cp \
  ./metrics/kube-prometheus-stack/component-monitors/proxmox/scrape-node-template.yaml \
  ./metrics/kube-prometheus-stack/component-monitors/proxmox/env/scrape-node.yaml
# adjust addresses for your environment
cat << EOF >> ./metrics/kube-prometheus-stack/component-monitors/proxmox/env/scrape-node.yaml
    targets:
    - pve1.k8s.lan
    - pve2.k8s.lan
    - pve3.k8s.lan
EOF
cluster_endpoint_address=pve1.k8s.lan
cluster_name=main
sed \
  -e "s/AUTOMATIC_REPLACE_TARGET/$cluster_endpoint/g" \
  -e "s/AUTOMATIC_REPLACE_CLUSTER_NAME/$cluster_name/g" \
  ./metrics/kube-prometheus-stack/component-monitors/proxmox/scrape-cluster-template.yaml \
  > ./metrics/kube-prometheus-stack/component-monitors/proxmox/env/scrape-cluster.yaml
```

# Updating dashboards

```bash
# remove id to avoid collisions
sed -i 's/^  \"id\": .*,/  \"id\": null,/' ./metrics/kube-prometheus-stack/component-monitors/proxmox/dashboards/*.json
# set dashboard refresh interval to auto
sed -i 's/^  \"refresh\": \".*s\",/  \"refresh\": \"auto\",/' ./metrics/kube-prometheus-stack/component-monitors/proxmox/dashboards/*.json
```

# Deploy

```bash
kl create ns pve-exporter
kl label ns pve-exporter pod-security.kubernetes.io/enforce=baseline

kl apply -k ./metrics/kube-prometheus-stack/component-monitors/proxmox/
kl apply -k ./metrics/kube-prometheus-stack/component-monitors/proxmox/dashboards/
kl -n pve-exporter get pod -o wide
kl -n pve-exporter get scrapeconfig
```

# Cleanup

```bash
kl delete -k ./metrics/kube-prometheus-stack/component-monitors/proxmox/dashboards/
kl delete -k ./metrics/kube-prometheus-stack/component-monitors/proxmox/
kl delete ns pve-exporter
```
