---
- name: Install zfs_exporter from PDF
  hosts: zfs
  become: true

  vars:
    zfs_exporter_version: 2.3.10
    local_binary_path: "./env/zfs_exporter-{{ zfs_exporter_version }}.linux-amd64/zfs_exporter"
    install_path: /opt/pdf_zfs_exporter

  tasks:
  - name: create /opt
    file:
      path: /opt
      state: directory
      mode: "0755"
      owner: root
      group: root

  - name: copy exporter binary
    copy:
      src: "{{ local_binary_path }}"
      dest: "{{ install_path }}"
      owner: root
      group: root
      mode: "0755"
    notify:
    - service_restart

  - name: create service group
    group:
      name: pdf_zfs_exporter
      state: present
      system: true
  - name: create service user
    user:
      name: pdf_zfs_exporter
      group: pdf_zfs_exporter
      shell: /usr/sbin/nologin
      create_home: false
      system: true
      state: present

  - name: copy pdf_zfs_exporter.service
    copy:
      src: ./pdf_zfs_exporter.service
      dest: /etc/systemd/system/pdf_zfs_exporter.service
      owner: root
      group: root
      mode: "0644"
    notify:
    - service_restart
    - systemd_daemon-reload

  handlers:
  - name: systemd_daemon-reload
    ansible.builtin.systemd_service:
      daemon_reload: true
  - name: Start pdf_zfs_exporter.service
    listen:
    - service_restart
    ansible.builtin.systemd_service:
      name: pdf_zfs_exporter.service
      enabled: true
      state: restarted
      daemon_reload: false
