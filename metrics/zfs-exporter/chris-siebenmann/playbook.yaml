---
- name: Install zfs_exporter from Chris Siebenmann
  hosts: zfs
  become: true

  vars:
    local_binary_path: ./env/zfs_exporter/zfs-exporter-chris
    install_path: /opt/chris_zfs_exporter

  tasks:
  - name: create /opt
    file:
      path: /opt
      state: directory
      mode: "0755"
      owner: root
      group: root

  - name: copy exporter binary
    copy:
      src: "{{ local_binary_path }}"
      dest: "{{ install_path }}"
      owner: root
      group: root
      mode: "0755"
    notify:
    - service_restart

  - name: create service group
    group:
      name: chris_zfs_exporter
      state: present
      system: true
  - name: create service user
    user:
      name: chris_zfs_exporter
      group: chris_zfs_exporter
      shell: /usr/sbin/nologin
      create_home: false
      system: true
      state: present

  - name: copy service
    copy:
      src: ./chris_zfs_exporter.service
      dest: /etc/systemd/system/chris_zfs_exporter.service
      owner: root
      group: root
      mode: "0644"
    notify:
    - service_restart
    - systemd_daemon-reload

  handlers:
  - name: systemd_daemon-reload
    ansible.builtin.systemd_service:
      daemon_reload: true
  - name: Start chris_zfs_exporter.service
    listen:
    - service_restart
    ansible.builtin.systemd_service:
      name: chris_zfs_exporter.service
      enabled: yes
      state: restarted
      daemon_reload: no
