---
name: metrics-cadvisor
services:
  cadvisor:
    container_name: '${COMPOSE_PROJECT_NAME}'
    image: ghcr.io/google/cadvisor:v0.53.0
    privileged: true
    restart: always
    command:
    # using default 8080 port to allow the default healthcheck to work
    - --port=8080
    - --allow_dynamic_housekeeping=true
    - --housekeeping_interval=2s
    - --max_housekeeping_interval=3s
    - --event_storage_event_limit=default=0
    - --event_storage_age_limit=default=0
    - --enable_metrics=cpu,diskIO,memory,network,pressure,process
    - --docker_only
    - --raw_cgroup_prefix_whitelist=/system.slice,/qemu.slice,/lxc,/lxc.monitor
    - --store_container_labels=false
    - --whitelisted_container_labels=com.docker.compose.image,com.docker.compose.service,com.docker.compose.project
    ports:
    - 8999:8080
    volumes:
    - /:/rootfs:ro
    - /sys:/sys:ro
    - /var/run:/var/run:ro
    - /var/lib/docker/:/var/lib/docker:ro
    - /dev/disk/:/dev/disk:ro
    deploy:
      resources:
        reservations:
          memory: 50M
          cpus: 0.05
        limits:
          # cadvisor memory usage heavily depends on the amount of cgroups on the system
          memory: 200M
          cpus: 0.3
