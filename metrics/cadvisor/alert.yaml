---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: alert-cadvisor-cpu-throttling
  namespace: metrics-cadvisor
  labels:
    prometheus.io/instance: main
    instance.prometheus.io/main: enable
    instance.prometheus.io/prompp: enable
spec:
  groups:
  - name: alert-cadvisor-cpu-throttling
    rules:
    - alert: ContainerCPUThrottlingHigh
      annotations:
        description: >-
          {{ $labels.namespace }}/{{ $labels.pod }}/{{ $labels.container }}:
          {{ $value | humanizePercentage }}
        summary: Container throttling rate is above 30%
      expr: |-
        (
          increase(container_cpu_cfs_throttled_periods_total[5m])
          /
          increase(container_cpu_cfs_periods_total[5m])
        ) > 0.3
      for: 15m
      labels:
        severity: info
---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: alert-cadvisor-memory
  namespace: metrics-cadvisor
  labels:
    prometheus.io/instance: main
    instance.prometheus.io/main: enable
    instance.prometheus.io/prompp: enable
spec:
  groups:
  - name: alert-cadvisor-memory
    rules:
    - alert: ContainerRSSCloseToLimit
      annotations:
        description: >-
          {{ $labels.namespace }}/{{ $labels.pod }}/{{ $labels.container }}:
          {{ $value | humanizePercentage }}
        summary: Container RSS is above 90% of memory limit
      expr: |-
        container_memory_rss / container_spec_memory_limit_bytes{} > 0.9
        and
        container_memory_working_set_bytes / container_spec_memory_limit_bytes{} > 0.97
        and
        container_spec_memory_limit_bytes != 0
      for: 5m
      labels:
        severity: warning
    - alert: ContainerRSSAtLimit
      annotations:
        description: >-
          {{ $labels.namespace }}/{{ $labels.pod }}/{{ $labels.container }}:
          {{ $value | humanizePercentage }}
        summary: Container RSS is above 97% of memory limit
      expr: |-
        container_memory_rss / container_spec_memory_limit_bytes{} > 0.97
        and
        container_memory_working_set_bytes / container_spec_memory_limit_bytes{} > 0.99
        and
        container_spec_memory_limit_bytes != 0
      for: 0m
      labels:
        severity: warning
