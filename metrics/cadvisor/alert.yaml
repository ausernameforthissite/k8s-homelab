---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: alert-cadvisor-cpu-throttling
  namespace: metrics-cadvisor
  labels:
    prometheus.io/instance: main
    instance.prometheus.io/main: enable
    instance.prometheus.io/prompp: enable
spec:
  groups:
  - name: alert-cadvisor-cpu-throttling
    rules:
    - alert: K8sCpuThrottling
      annotations:
        description: >-
          {{ $labels.namespace }}/{{ $labels.pod }}/{{ $labels.container }}:
          {{ $value | humanizePercentage }}
        summary: K8s container is throttling on > 30% of scheduling periods
      expr: |-
        (
          increase(container_cpu_cfs_throttled_periods_total{namespace!=""}[5m])
          /
          increase(container_cpu_cfs_periods_total{namespace!=""}[5m])
        ) > 0.3
        # cut removed containers instantly
        and container_cpu_cfs_throttled_periods_total{namespace!=""}
      for: 15m
      labels:
        severity: info
    - alert: DockerCpuThrottling
      annotations:
        description: >-
          instance {{ $labels.instance }}: {{ $labels.name }}:
          {{ $value | humanizePercentage }}
        summary: Docker container is throttling on > 30% of scheduling periods
      expr: |-
        (
          increase(container_cpu_cfs_throttled_periods_total{namespace="", name!=""}[5m])
          /
          increase(container_cpu_cfs_periods_total{namespace="", name!=""}[5m])
        ) > 0.3
        # cut removed containers instantly
        and container_cpu_cfs_throttled_periods_total{namespace="", name!=""}
      for: 15m
      labels:
        severity: info
    - alert: CgroupCpuThrottling
      annotations:
        description: >-
          instance {{ $labels.instance }}: {{ $labels.id }}:
          {{ $value | humanizePercentage }}
        summary: Cgroup is throttling on > 30% of scheduling periods
      expr: |-
        (
          increase(container_cpu_cfs_throttled_periods_total{namespace="", name=""}[5m])
          /
          increase(container_cpu_cfs_periods_total{namespace="", name=""}[5m])
        ) > 0.3
        # cut removed containers instantly
        and container_cpu_cfs_throttled_periods_total{namespace="", name=""}
      for: 15m
      labels:
        severity: info
---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: alert-cadvisor-memory
  namespace: metrics-cadvisor
  labels:
    prometheus.io/instance: main
    instance.prometheus.io/main: enable
    instance.prometheus.io/prompp: enable
spec:
  groups:
  - name: alert-cadvisor-memory
    rules:
    - alert: ContainerRSSCloseToLimit
      annotations:
        description: >-
          {{ $labels.namespace }}/{{ $labels.pod }}/{{ $labels.container }}:
          {{ $value | humanizePercentage }}
        summary: Container RSS is above 90% of memory limit
      expr: |-
        container_memory_rss / container_spec_memory_limit_bytes{} > 0.9
        and
        container_memory_working_set_bytes / container_spec_memory_limit_bytes{} > 0.97
        and
        container_spec_memory_limit_bytes != 0
      for: 5m
      labels:
        severity: warning
    - alert: ContainerRSSAtLimit
      annotations:
        description: >-
          {{ $labels.namespace }}/{{ $labels.pod }}/{{ $labels.container }}:
          {{ $value | humanizePercentage }}
        summary: Container RSS is above 97% of memory limit
      expr: |-
        container_memory_rss / container_spec_memory_limit_bytes{} > 0.97
        and
        container_memory_working_set_bytes / container_spec_memory_limit_bytes{} > 0.99
        and
        container_spec_memory_limit_bytes != 0
      for: 0m
      labels:
        severity: warning
