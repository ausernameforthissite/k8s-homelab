---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: alert-smartctl-exporter
  namespace: prometheus
  labels:
    prometheus.io/instance: main
    instance.prometheus.io/main: enable
    instance.prometheus.io/prompp: enable
spec:
  groups:
  - name: alert-smartctl-exporter
    rules:
    - alert: SmartDeviceTemperatureOver75
      expr: |-
        (
          avg_over_time(smartctl_device_temperature{temperature_type="current"}[1m]) > 75
        ) or (
          # hysteresis: don't disable alert unless temperature is below 65
          avg_over_time(smartctl_device_temperature{temperature_type="current"}[5m]) > 65
          and ignoring(alertname, alertstate, severity)
          ALERTS{alertname="SmartDeviceTemperatureOver75", alertstate="firing"}
        )
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: Disk temperature is above 75°C
        description: >-
          {{ $labels.instance }}:
          drive {{ $labels.device }}:
          {{ $value | humanize }}°C
    - alert: SmartDeviceTempOverTrip
      expr: |-
        max_over_time(smartctl_device_temperature{temperature_type="current"} [1m]) != 0
        >= on(device, instance) group_left()
        smartctl_device_temperature{temperature_type="drive_trip"}
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: Disk temperature is over trip value
        description: >-
          {{ $labels.instance }}:
          drive {{ $labels.device }}:
          {{ $value | humanize }}°C
    - alert: SmartDeviceTempeOverOperationalLimit
      expr: |-
        (
          max_over_time(smartctl_device_temperature{temperature_type="current"} [1m]) != 0
          >= ignoring(temperature_type)
          smartctl_device_temperature{temperature_type="op_limit_max"}
        ) or (
          # hysteresis: don't disable alert unless temperature is 10 degree below limit
          max_over_time(smartctl_device_temperature{temperature_type="current"} [1m]) != 0
          >= ignoring(temperature_type)
          (smartctl_device_temperature{temperature_type="op_limit_max"} - 10)
          and ignoring(alertname, alertstate, severity, temperature_type)
          ALERTS{alertname="SmartDeviceTempeOverOperationalLimit", alertstate="firing"}
        )
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: Disk temperature is over operational limit
        description: >-
          {{ $labels.instance }}:
          drive {{ $labels.device }}:
          {{ $value | humanize }}°C
    - alert: SmartDeviceTempeOverCriticalLimit
      expr: |-
        (
          max_over_time(smartctl_device_temperature{temperature_type="current"} [1m]) != 0
          >= ignoring(temperature_type)
          smartctl_device_temperature{temperature_type="critical_limit_max"}
        ) or (
          # hysteresis: don't disable alert unless temperature is 10 degree below limit
          max_over_time(smartctl_device_temperature{temperature_type="current"} [1m]) != 0
          >= ignoring(temperature_type)
          (smartctl_device_temperature{temperature_type="critical_limit_max"} - 10)
          and ignoring(alertname, alertstate, severity, temperature_type)
          ALERTS{alertname="SmartDeviceTempeOverCriticalLimit", alertstate="firing"}
        )
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: Disk temperature is over critical limit
        description: >-
          {{ $labels.instance }}:
          drive {{ $labels.device }}:
          {{ $value | humanize }}°C
    - alert: SmartStatusError
      expr: |-
        (
          max_over_time(smartctl_device_smart_status[1m]) != 1
        ) or (
          # hysteresis: don't disable alert unless at least half of queries were successful in last 15 minutes
          quantile_over_time(0.5, smartctl_device_smart_status[15m]) != 1
          and ignoring(alertname, alertstate, severity)
          ALERTS{alertname="SmartStatusError", alertstate="firing"}
        )
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: Disk SMART failed
        description: >-
          {{ $labels.instance }}:
          drive {{ $labels.device }}
    - alert: SmartCriticalWarning
      expr: |-
        (
          min_over_time(smartctl_device_critical_warning[1m]) != 0
        ) or (
          # hysteresis: don't disable alert unless at least half of queries were successful in last 15 minutes
          quantile_over_time(0.5, smartctl_device_critical_warning[15m]) != 0
          and ignoring(alertname, alertstate, severity)
          ALERTS{alertname="SmartCriticalWarning", alertstate="firing"}
        )
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: SMART critical warning
        description: >-
          {{ $labels.instance }}:
          drive {{ $labels.device }}
    - alert: SmartMediaErrors
      expr: increase(smartctl_device_media_errors[6h]) > 0
      for: 0m
      labels:
        severity: critical
      annotations:
        summary: New SMART media errors
        description: >-
          {{ $labels.instance }}:
          drive {{ $labels.device }}:
          {{ $value | humanize }}
    - alert: SmartWearoutIndicator
      expr: smartctl_device_available_spare < smartctl_device_available_spare_threshold
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: Available spare is below threshold
        description: >-
          {{ $labels.instance }}:
          drive {{ $labels.device }}:
          {{ $value | humanize }}
