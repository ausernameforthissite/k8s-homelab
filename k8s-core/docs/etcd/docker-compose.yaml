---
name: etcd
services:
  cadvisor:
    container_name: '${COMPOSE_PROJECT_NAME}'
    image: gcr.io/etcd-development/etcd:v3.6.4
    restart: always
    command:
    - /usr/local/bin/etcd
    - --heartbeat-interval=500
    - --election-timeout=5000
    - --data-dir=/var/lib/etcd
    - --auto-compaction-retention=24h
    - --auto-compaction-mode=periodic
    - --peer-client-cert-auth
    - --peer-trusted-ca-file=/etc/etcd/pki/ca.pem
    - --peer-cert-file=/etc/etcd/pki/etcd-node.pem
    - --peer-key-file=/etc/etcd/pki/etcd-node-key.pem
    - --client-cert-auth
    - --trusted-ca-file=/etc/etcd/pki/ca.pem
    - --cert-file=/etc/etcd/pki/etcd-node.pem
    - --key-file=/etc/etcd/pki/etcd-node-key.pem
    - --initial-cluster-state=new
    - --initial-cluster-token={{ etcd_cluster_token }}
    - --name={{ etcd_node_name }}
    - --initial-advertise-peer-urls={{ etcd_node_peer_address }}
    - --initial-cluster={{ etcd_init_cluster_nodes }}
    - --advertise-client-urls={{ etcd_node_peer_address }}
    - --listen-client-urls=https://0.0.0.0:2379
    - --listen-peer-urls=https://0.0.0.0:2380
    # - --listen-metrics-urls=https://0.0.0.0:2381
    ports:
    - 2379:2379
    - 2380:2380
    volumes:
    - ./data:/var/lib/etcd:rw
    - ./pki:/etc/etcd/pki/:ro
    # deploy:
    #   resources:
    #     limits:
    #       memory: 200M
    #       cpus: 0.3
