---
- name: Install k8s dependencies
  hosts: kubelet
  become: true

  vars:
    runc_version: 1.3.1
    containerd_version: 2.1.4
    crictl_version: v1.34.0
    kubelet_version: v1.34.1
    kubeadm_version: v1.34.1

  tasks:

  - name: setup kernel modules
    ansible.builtin.copy:
      src: ./containerd-modules.conf
      dest: /etc/modules-load.d/containerd.conf
      owner: root
      group: root
      mode: "0644"
    notify:
    - modules_service_restart

  - name: copy sysctl config file
    become: true
    ansible.builtin.copy:
      src: ./sysctl/{{ item }}
      dest: /etc/sysctl.d/{{ item }}
      owner: root
      group: root
      mode: "0644"
    loop:
    - kubernetes.conf
    - inotify.conf
    - apr_proxy.conf
    notify:
    - sysctl_apply

  - name: copy runc binary
    ansible.builtin.copy:
      src: ./env/runc-{{ runc_version }}.amd64
      dest: /usr/local/sbin/runc
      owner: root
      group: root
      mode: "0755"

  - name: copy containerd binary
    ansible.builtin.copy:
      src: ./env/containerd-{{ containerd_version}}/bin/
      dest: /usr/local/bin/
      owner: root
      group: root
      mode: "0755"
    notify:
    - containerd_service_restart

  - name: remove containerd service on path from guides
    ansible.builtin.file:
      path: /usr/lib/systemd/system/containerd.service
      state: absent
    notify:
    - systemd_daemon-reload
    - containerd_service_restart

  - name: copy containerd.service
    copy:
      src: ./containerd.service
      dest: /etc/systemd/system/containerd.service
      owner: root
      group: root
      mode: "0644"
    notify:
    - systemd_daemon-reload
    - containerd_service_restart

  - name: copy crictl binary
    ansible.builtin.copy:
      src: ./env/crictl-{{ crictl_version }}/crictl
      dest: /usr/local/bin/crictl
      owner: root
      group: root
      mode: "0755"

  - name: remove k8s apt packages
    ansible.builtin.apt:
      name: "{{ item }}"
      state: absent
      allow_change_held_packages: true
    loop:
    - kubelet
    - kubeadm

  - name: copy kubelet binary
    ansible.builtin.copy:
      src: ./env/kubelet-{{ kubelet_version }}.amd64
      dest: /usr/local/bin/kubelet
      owner: root
      group: root
      mode: "0755"
    notify:
    - kubelet_service_restart

  - name: copy kubelet.service
    copy:
      src: ./kubelet.service
      dest: /etc/systemd/system/kubelet.service
      owner: root
      group: root
      mode: "0644"
    notify:
    - systemd_daemon-reload
    - kubelet_service_restart

  - name: create kubelet.service.d
    ansible.builtin.file:
      path: /etc/systemd/system/kubelet.service.d/
      state: directory
      mode: '0755'
      
  - name: copy kubelet-kubeadm.conf
    copy:
      src: ./kubelet-kubeadm.service
      dest: /etc/systemd/system/kubelet.service.d/kubelet-kubeadm.conf
      owner: root
      group: root
      mode: "0644"
    notify:
    - systemd_daemon-reload
    - kubelet_service_restart

  - name: copy kubeadm binary
    ansible.builtin.copy:
      src: ./env/kubeadm-{{ kubeadm_version }}.amd64
      dest: /usr/local/bin/kubeadm
      owner: root
      group: root
      mode: "0755"

  handlers:
  - name: apply sysctl params
    listen:
    - sysctl_apply
    shell: sysctl --system
  - name: crictl config
    listen:
    - crictl_config
    shell: crictl config --set runtime-endpoint=unix:///run/containerd/containerd.sock --set image-endpoint=unix:///run/containerd/containerd.sock
  - name: systemd_daemon-reload
    ansible.builtin.systemd_service:
      daemon_reload: true
  - name: restart systemd-modules-load.service
    listen:
    - modules_service_restart
    ansible.builtin.systemd_service:
      name: systemd-modules-load.service
      enabled: true
      state: restarted
      daemon_reload: false
  - name: restart containerd.service
    listen:
    - containerd_service_restart
    ansible.builtin.systemd_service:
      name: containerd.service
      enabled: true
      state: restarted
      daemon_reload: false
  - name: restart kubelet.service
    listen:
    - kubelet_service_restart
    ansible.builtin.systemd_service:
      name: kubelet.service
      enabled: true
      state: restarted
      daemon_reload: false
