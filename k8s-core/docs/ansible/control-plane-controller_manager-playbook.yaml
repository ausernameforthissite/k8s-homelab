---
- name: Install k8s dependencies
  hosts: k8s_control_plane
  become: false

  vars:
    project_root: ~/kube-control-plane/controller-manager

  tasks:

  - name: create CSR
    delegate_to: localhost
    become: false
    ansible.builtin.template:
      src: ./csr/controller-manager-template.json
      dest: ./env/cluster-{{ k8s_cluster_name }}/pki/controller-manager-{{ ansible_host }}.json
    register: csr

  - name: create cert
    delegate_to: localhost
    become: false
    ansible.builtin.shell: |
      set -e
      set -o pipefail
      cfssl gencert \
        -ca ./env/cluster-{{ k8s_cluster_name }}/ca/ca.pem \
        -ca-key ./env/cluster-{{ k8s_cluster_name }}/ca/ca-key.pem \
        -config ./csr/ca-config.json \
        -profile controller-manager \
        ./env/cluster-{{ k8s_cluster_name }}/pki/controller-manager-{{ ansible_host }}.json \
        | cfssljson -bare ./env/cluster-{{ k8s_cluster_name }}/pki/controller-manager-{{ ansible_host }}
    when: csr.changed

  - name: create folders
    ansible.builtin.file:
      path: "{{ project_root }}/pki"
      state: directory
      mode: "0755"

  - name: copy ca
    ansible.builtin.copy:
      src: ./env/cluster-{{ k8s_cluster_name }}/ca/ca.pem
      dest: "{{ project_root }}/pki/ca.pem"
      mode: preserve

  - name: copy ca key
    ansible.builtin.copy:
      src: ./env/cluster-{{ k8s_cluster_name }}/ca/ca-key.pem
      dest: "{{ project_root }}/pki/ca-key.pem"
      mode: preserve
    notify:
    - restart_docker_compose

  - name: copy pki
    ansible.builtin.copy:
      src: ./env/cluster-{{ k8s_cluster_name }}/{{ item.source }}
      dest: "{{ project_root }}/{{ item.dest }}"
      mode: preserve
    loop:
    - { source: "pki/controller-manager-{{ ansible_host }}.pem", dest: pki/client.pem }
    - { source: "pki/controller-manager-{{ ansible_host }}-key.pem", dest: pki/client-key.pem }
    - { source: pki/service-accounts-key.pem, dest: pki/service-accounts-key.pem }
    notify:
    - restart_docker_compose

  - name: copy kubeconfig
    ansible.builtin.template:
      src: ./generic-kubeconfig.yaml
      dest: "{{ project_root }}/kubeconfig.yaml"
      mode: "0644"
    notify:
    - restart_docker_compose

  - name: copy docker-compose.yaml
    ansible.builtin.template:
      src: ./docker-compose/controller-manager-docker-compose.yaml
      dest: "{{ project_root }}/docker-compose.yaml"
      mode: "0644"

  - name: start docker compose
    community.docker.docker_compose_v2:
      project_src: "{{ project_root }}"
      files:
      - docker-compose.yaml
      state: present
      wait: true
      wait_timeout: 300
      remove_orphans: true
    register: start_docker_compose

  handlers:
  - name: restart docker compose
    # restart handles cases when app config changed but compose file didn't
    listen:
    - restart_docker_compose
    community.docker.docker_compose_v2:
      project_src: "{{ project_root }}"
      files:
      - docker-compose.yaml
      state: present
      wait: true
      wait_timeout: 300
      remove_orphans: true
    when: not start_docker_compose.changed
